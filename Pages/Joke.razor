@page "/joke"
@inject HttpClient Http
@using System.Text.Json
<PageTitle>Joke</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">生成笑话</MudText>

<MudButton OnClick="@GenerateJoke" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Refresh"
           Color="Color.Primary">生成
</MudButton>

@if (_joke != null)
{
    <MudCard Class="mt-4">
        <MudCardContent>
            <MudText Typo="Typo.body1" Class="mt-2">@_joke.Value</MudText>
            <MudText Typo="Typo.overline" Class="mt-2 d-flex justify-end">
                <MudLink Href="@_joke.Url" Target="_blank">View Original Joke</MudLink>
            </MudText>
        </MudCardContent>
    </MudCard>
}
else if (_loading)
{
    <div class="mt-4">
        <MudProgressCircular Indeterminate="true"/>
    </div>
}
else if (!string.IsNullOrEmpty(_error))
{
    <MudAlert Severity="Severity.Error" Class="mt-4">@_error</MudAlert>
}

@code {
    private JokeItem? _joke;
    private bool _loading;
    private string? _error;

    private async Task GenerateJoke()
    {
        _loading = true;
        _error = null;
        _joke = null;
        try
        {
            var response = await Http.GetAsync("api/joke");
            
            if (!response.IsSuccessStatusCode)
            {
                _error = $"API请求失败: /api/joke 返回状态码 {(int)response.StatusCode} ({response.StatusCode})";
                return;
            }
            
            var contentType = response.Content.Headers.ContentType?.MediaType;
            if (contentType != "application/json")
            {
                _error = $"API错误: /api/joke 返回了非JSON格式的内容 ({contentType ?? "未知类型"})，API服务可能未启动";
                return;
            }
            
            var content = await response.Content.ReadAsStringAsync();
            _joke = JsonSerializer.Deserialize<JokeItem>(content, new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.SnakeCaseLower,
                PropertyNameCaseInsensitive = true
            });
        }
        catch (HttpRequestException ex)
        {
            _error = $"网络请求失败: /api/joke 无法连接 - {ex.Message}";
        }
        catch (JsonException ex)
        {
            _error = $"JSON解析失败: /api/joke 返回的数据格式不正确 - {ex.Message}";
        }
        catch (Exception ex)
        {
            _error = $"加载笑话失败: {ex.GetType().Name} - {ex.Message}";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

}